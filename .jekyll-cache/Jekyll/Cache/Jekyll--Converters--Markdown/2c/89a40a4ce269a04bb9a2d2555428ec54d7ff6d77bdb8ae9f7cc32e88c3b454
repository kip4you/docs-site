I"ƒ<h1 id="email-connector">Email Connector</h1>

<h2 id="1-camunda">1. Camunda</h2>

<p>Initially to create an Email, we need to configure our Camunda BPMN.</p>

<p><img src="./assets/images/email-connector/BPMNEmail.png" alt="Simple example of BPMN" /></p>

<p>In this case it is common to have a task before send the Email in our case we have the <strong>Assess Quotation</strong> task a User Task, that simply approve or disapprove a quotation. If the quotation is approved than it send the <strong>Email Approval Quotation</strong> and if it is not approved it send <strong>Email Disapproval Quotation</strong>.</p>

<p>To simplify this tutorial weâ€™ll only do the Email Approval Quotation. CLicking in the send task we open a tab to configure, first we click in <strong>Implementation</strong> and set te Type to <strong>Delegate Expression</strong> and put in Delegate expression <strong>${akipEmailConnectorDelegate}</strong>, this delegate already exists as a compiled class when we generate the base project.</p>

<p><img src="./assets/images/email-connector/SendTaskImplemantation.png" alt="Email Implementation Configuration" style="display:block; margin-left:auto; margin-right:auto" /></p>

<p>Still in the configuration of Email Approval Quotation we click in <strong>Field injections</strong> and click in <strong>Create a new list item</strong> (plus icon), weâ€™ll add the Name <strong>akipEmailConnectorConfigName</strong>, Type <strong>String</strong> and then the Value that we put the name of the process dot the name of our task using <strong>CamelCase</strong>, in our case it will be <strong>QuotationProcess.EmailApprovalQuotation</strong>.</p>

<p><img src="./assets/images/email-connector/SendTaskInjection.png" alt="Email Field Injection Configuration" style="display:block; margin-left:auto; margin-right:auto" /></p>

<h2 id="2-project-generation">2. Project Generation</h2>

<p>Before we pass to the coding the Email task, we need first to install the AgileKIP Generator to execute the project using the jhipster blueprint, after this we need to create the metadata of the domain, entities and their relations. To create the project step by step itâ€™s recommended to read the tutorial <a href="https://agilekip.github.io/pap-documentation/tutorials/generating-an-app" style="color: blue">here</a></p>

<h2 id="3-into-the-code">3. Into the code</h2>

<p>After we config the Email task in Camunda, just need to construct the body of the email. For that weâ€™ll start by entering the folder with the name of the process through this path: <strong>src &gt; main &gt; resources &gt; config &gt; liquibase &gt; data &gt; quotationProcess</strong> (in our case). Inside this folder we create three types of file to construct the email: the <strong>content.txt</strong>, <strong>mailbox.txt</strong> and the <strong>subject.txt</strong> all with the name of the process dot the name of the task (example: QuotationProcess.EmailApprovalQuotation.content.txt).</p>

<p><img src="./assets/images/email-connector/pathEmail.png" alt="Path to body of the email" /></p>

<p>First in the subject.txt weâ€™ll fill this file with the title of the Email. Notice that inside this txt we can bring the value of some attribute using the <strong>${}</strong>.</p>

<p><img src="./assets/images/email-connector/subject.png" alt="Email subject" /></p>

<p>Now inside the mailbox.txt we define the emails address that this emails will be sent.</p>

<p><img src="./assets/images/email-connector/mailbox.png" alt="Email content" /></p>

<p>The last step to construct the body of the email is the content, inside the content.txt we write what we want to present for the user using &lt;p&gt;&lt;/p&gt; tags.</p>

<p><img src="./assets/images/email-connector/content.png" alt="Email content" /></p>

<p>We can manipulate data in this file using SQL, doing for loops, whiles and other stuff, here is another example of a content.txt for an email (Email RFQ Summary) of a summary of items that have been quoted.</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>String requisicaoHql = """ SELECT q FROM Quotation q WHERE q.requestForQuotation.id = ${processEntity.requestForQuotation.id} """
def listQuotations = hqlApi.findList(requisicaoHql)
 def tableQuotations =   """
    <span class="nt">&lt;p&gt;</span>Dear ${processEntity.requestForQuotation.user.login}<span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;p&gt;</span>Below is the summary containing all quotations for the item ${processEntity.requestForQuotation.item.name}<span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;/br&gt;</span>
"""
 tableQuotations += """<span class="nt">&lt;table</span> <span class="na">border=</span><span class="s">"1"</span> <span class="na">style=</span><span class="s">"width: 100%"</span><span class="nt">&gt;</span>
                          <span class="nt">&lt;tr&gt;</span>
                                   <span class="nt">&lt;td&gt;</span>Name<span class="nt">&lt;/td&gt;</span>
                                   <span class="nt">&lt;td&gt;</span>Description<span class="nt">&lt;/td&gt;</span>
                                   <span class="nt">&lt;td&gt;</span>Price<span class="nt">&lt;/td&gt;</span>
                          <span class="nt">&lt;/tr&gt;</span>
                          """
    listQuotations.findAll{ quotation -&gt; quotation.statusQuotation.toString() != 'DISAPPROVED' }.each{ quotation -&gt;
      tableQuotations += """
         <span class="nt">&lt;tr&gt;</span>
         <span class="nt">&lt;td&gt;</span>
           <span class="nt">&lt;p&gt;</span>${quotation.provider.name}<span class="nt">&lt;/p&gt;</span>
         <span class="nt">&lt;/td&gt;</span>
          <span class="nt">&lt;td&gt;</span>
           <span class="nt">&lt;p&gt;</span>${quotation.requestForQuotation.item.description}<span class="nt">&lt;/p&gt;</span>
          <span class="nt">&lt;/td&gt;</span>
          <span class="nt">&lt;td&gt;</span>
           <span class="nt">&lt;p&gt;</span>US\$ ${quotation.price}<span class="nt">&lt;/p&gt;</span>
          <span class="nt">&lt;/td&gt;</span>
     <span class="nt">&lt;/tr&gt;</span>
     """
     }
tableQuotations +="<span class="nt">&lt;/table&gt;</span>"
"""
${tableQuotations}
<span class="nt">&lt;p&gt;</span>Regards, AgileKip Team<span class="nt">&lt;/p&gt;</span>
"""
</code></pre></div></div>

<p>Finishing the body of the email, we must create a ChangeLog to persist the email, for this weâ€™ll go to the changelog file: <strong>src &gt; main &gt; resources &gt; config &gt; liquibase &gt; changelog</strong>. We need to create a file containing this format: year followed by month and followed by the actual day, together with the order of creation in that day (example: <strong>20221021000001_insert_EmailActionConfig_NameOfProcess_NomeOfSendTask.xml</strong>).</p>

<p><img src="./assets/images/email-connector/changelogPath.png" alt="Change log path" /></p>

<p>Following the red marks, we must create a changeSet to insert the email. Attention to the moment you identify the changeSet id, you need to write like the name of the changelog, but just with the numbers part, followed by a dash and the respective value of the changelog using ascending order.</p>
:ET