I"z^<h1 id="subprocess">Subprocess</h1>

<h2 id="working-with-subprocess">Working with subprocess</h2>
<p>A sub-process is a means of entering a flow of an alternate process during the execution of the main process.<br />
To better understand how the creation of a subprocess is performed, the example of a quotation application will be used.</p>

<h2 id="lets-do-a-example">Let’s do a example</h2>

<p>The first thing we will do is create a task and define it as a sub-process by selecting
<strong>Call Activity</strong> and <strong>Parallel Multi-Instance</strong> as shown in the red underline in the image below:</p>

<p><img src="assets/images/subprocess/taskConfigure_subprocess.png" alt="Task Configure Subprocess" /></p>

<p>After the task created, you must define a name and id in <strong>General</strong>, in the <strong>multi-instance</strong> tab we will inform that the subprocess will receive a <strong>Collection</strong> of elements called <em>quotationProcesses</em>,
referring to a List containing all the suppliers available to quotation and in <strong>Element Variable</strong> will be set
to the name of <em>quotationProcess</em> that refers to each instance of quotationProcesses.</p>

<p><img src="assets/images/subprocess/TaskSubprocessProperties_configure.png" alt="Subprocess properties Configure " style="display:block; margin-left:auto; margin-right:auto" /></p>

<p>On the <strong>Called Element</strong> tab, some things will be defined such as:</p>

<p><strong>Type</strong>: BPMN
<br />
<strong>Called Element</strong>: quotationProcess</p>

<p>Also select the <strong>Bussines Key</strong> checkbox with this the <strong>Bussines Key Expression</strong>
field will be enabled where we will define <strong>#{quotationProcess.getQuotation().number}</strong> this being the business key created for the quote.</p>

<p><img src="assets/images/subprocess/TaskSubprocessProperties_configureCalledElement.png" alt="Subprocess properties Configure Called Element" style="display:block; margin-left:auto; margin-right:auto" /></p>

<p>Then create a <strong>Java Delegate</strong> class with the name <em>quotationProcessVarMappingDelegate</em> that implements the <strong>DelegateVariableMapping</strong> interface, 
this is necessary because we need to change the <strong>ProcessEntity</strong> reference from <strong>RequestForQuotationProcess</strong> to <strong>QuotationProcess</strong>, 
when this exchange of reference is performed on the <strong>ProcessEntity</strong>, 
the <strong>QuotationProcess</strong> also receives a reference to <strong>RequestForQuotationProcess</strong> so that the reference of the previous process is not lost.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">QuotationProcessVarMappingDelegate</span> <span class="kd">implements</span> <span class="nc">DelegateVariableMapping</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">mapInputVariables</span><span class="o">(</span><span class="nc">DelegateExecution</span> <span class="n">delegateExecution</span><span class="o">,</span> <span class="nc">VariableMap</span> <span class="n">variableMap</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">variableMap</span><span class="o">.</span><span class="na">putValue</span><span class="o">(</span>
            <span class="nc">RequestForQuotationProcessConstants</span><span class="o">.</span><span class="na">REQUEST_FOR_QUOTATION_PROCESS</span><span class="o">,</span>
            <span class="n">delegateExecution</span><span class="o">.</span><span class="na">getVariable</span><span class="o">(</span><span class="nc">CamundaConstants</span><span class="o">.</span><span class="na">PROCESS_ENTITY</span><span class="o">)</span>
        <span class="o">);</span>
        <span class="n">variableMap</span><span class="o">.</span><span class="na">putValue</span><span class="o">(</span><span class="nc">CamundaConstants</span><span class="o">.</span><span class="na">PROCESS_ENTITY</span><span class="o">,</span> <span class="n">delegateExecution</span><span class="o">.</span><span class="na">getVariable</span><span class="o">(</span><span class="nc">QuotationProcessConstants</span><span class="o">.</span><span class="na">QUOTATION_PROCESS</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">mapOutputVariables</span><span class="o">(</span><span class="nc">DelegateExecution</span> <span class="n">delegateExecution</span><span class="o">,</span> <span class="nc">VariableScope</span> <span class="n">variableScope</span><span class="o">)</span> <span class="o">{}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>After we prepare our subprocess, we will create a Service Task with the name <em>Create Quotation Processes</em> 
implementing the <strong>Delegate Expression</strong> <em>requestForQuotationProcessTaskCreateQuotationProcessesDelegate</em>,
being responsible for preparing the list of subprocesses and instantiating the quotationProcess information for the subprocess.</p>

<p><img src="assets/images/subprocess/ServiceTaskCreateQuotationProcesses.png" alt="Service Task Create Quotation Processes" style="display:block; margin-left:auto; margin-right:auto" /></p>

<p>Inside the Java Delegate insert this code snippet:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RequestForQuotationProcessTaskCreateQuotationProcessesDelegate</span> <span class="kd">implements</span> <span class="nc">JavaDelegate</span> <span class="o">{</span>

   <span class="nd">@Autowired</span>
   <span class="kd">private</span> <span class="nc">RequestForQuotationProcessRepository</span> <span class="n">requestForQuotationProcessRepository</span><span class="o">;</span>

   <span class="nd">@Autowired</span>
   <span class="kd">private</span> <span class="nc">RequestForQuotationRepository</span> <span class="n">requestForQuotationRepository</span><span class="o">;</span>

   <span class="nd">@Autowired</span>
   <span class="kd">private</span> <span class="nc">ProviderMapper</span> <span class="n">providerMapper</span><span class="o">;</span>

   <span class="nd">@Autowired</span>
   <span class="kd">private</span> <span class="nc">QuotationProcessMapper</span> <span class="n">quotationProcessMapper</span><span class="o">;</span>

   <span class="nd">@Autowired</span>
   <span class="kd">private</span> <span class="nc">QuotationProcessRepository</span> <span class="n">quotationProcessRepository</span><span class="o">;</span>

   <span class="nd">@Override</span>
   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="nc">DelegateExecution</span> <span class="n">delegateExecution</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
       <span class="nc">RequestForQuotationProcessDTO</span> <span class="n">requestForQuotationProcessDTO</span> <span class="o">=</span> <span class="o">(</span><span class="nc">RequestForQuotationProcessDTO</span><span class="o">)</span> <span class="n">delegateExecution</span><span class="o">.</span><span class="na">getVariable</span><span class="o">(</span>
           <span class="nc">CamundaConstants</span><span class="o">.</span><span class="na">PROCESS_ENTITY</span>
       <span class="o">);</span>
       <span class="nc">RequestForQuotationProcess</span> <span class="n">requestForQuotationProcess</span> <span class="o">=</span> <span class="n">requestForQuotationProcessRepository</span>
           <span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">requestForQuotationProcessDTO</span><span class="o">.</span><span class="na">getId</span><span class="o">())</span>
           <span class="o">.</span><span class="na">orElseThrow</span><span class="o">();</span>
       <span class="n">updatedRequestForQuotationStatus</span><span class="o">(</span><span class="n">requestForQuotationProcess</span><span class="o">.</span><span class="na">getRequestForQuotation</span><span class="o">());</span>
       <span class="nc">List</span><span class="o">&lt;</span><span class="nc">QuotationProcessDTO</span><span class="o">&gt;</span> <span class="n">quotationProcesses</span> <span class="o">=</span> <span class="n">createQuotationProcesses</span><span class="o">(</span>
           <span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">ProviderDTO</span><span class="o">&gt;)</span> <span class="n">delegateExecution</span><span class="o">.</span><span class="na">getVariable</span><span class="o">(</span><span class="nc">RequestForQuotationProcessConstants</span><span class="o">.</span><span class="na">PROVIDERS</span><span class="o">),</span>
           <span class="n">requestForQuotationProcess</span>
       <span class="o">);</span>
       <span class="n">delegateExecution</span><span class="o">.</span><span class="na">setVariable</span><span class="o">(</span><span class="nc">RequestForQuotationProcessConstants</span><span class="o">.</span><span class="na">QUOTATION_PROCESSES</span><span class="o">,</span> <span class="n">quotationProcesses</span><span class="o">);</span>
   <span class="o">}</span>

   <span class="kd">private</span> <span class="kt">void</span> <span class="nf">updatedRequestForQuotationStatus</span><span class="o">(</span><span class="nc">RequestForQuotation</span> <span class="n">requestForQuotation</span><span class="o">)</span> <span class="o">{</span>
       <span class="n">requestForQuotationRepository</span><span class="o">.</span><span class="na">updateStatusById</span><span class="o">(</span><span class="nc">StatusRFQ</span><span class="o">.</span><span class="na">QUOTING</span><span class="o">,</span> <span class="n">requestForQuotation</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
   <span class="o">}</span>

   <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">QuotationProcessDTO</span><span class="o">&gt;</span> <span class="nf">createQuotationProcesses</span><span class="o">(</span>
       <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ProviderDTO</span><span class="o">&gt;</span> <span class="n">providers</span><span class="o">,</span>
       <span class="nc">RequestForQuotationProcess</span> <span class="n">requestForQuotationProcess</span>
   <span class="o">)</span> <span class="o">{</span>
       <span class="nc">List</span><span class="o">&lt;</span><span class="nc">QuotationProcessDTO</span><span class="o">&gt;</span> <span class="n">quotationProcesses</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
       <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
       <span class="k">for</span> <span class="o">(</span><span class="nc">ProviderDTO</span> <span class="n">provider</span> <span class="o">:</span> <span class="n">providers</span><span class="o">)</span> <span class="o">{</span>
           <span class="n">quotationProcesses</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">createQuotationProcess</span><span class="o">(</span><span class="n">requestForQuotationProcess</span><span class="o">,</span> <span class="n">providerMapper</span><span class="o">.</span><span class="na">toEntity</span><span class="o">(</span><span class="n">provider</span><span class="o">),</span> <span class="n">index</span><span class="o">++));</span>
       <span class="o">}</span>
       <span class="k">return</span> <span class="n">quotationProcesses</span><span class="o">;</span>
   <span class="o">}</span>

   <span class="kd">private</span> <span class="nc">QuotationProcessDTO</span> <span class="nf">createQuotationProcess</span><span class="o">(</span>
       <span class="nc">RequestForQuotationProcess</span> <span class="n">requestForQuotationProcess</span><span class="o">,</span>
       <span class="nc">Provider</span> <span class="n">provider</span><span class="o">,</span>
       <span class="kt">int</span> <span class="n">index</span>
   <span class="o">)</span> <span class="o">{</span>
       <span class="nc">QuotationProcess</span> <span class="n">quotationProcess</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">QuotationProcess</span><span class="o">();</span>
       <span class="n">quotationProcess</span><span class="o">.</span><span class="na">setQuotation</span><span class="o">(</span><span class="k">new</span> <span class="nc">Quotation</span><span class="o">());</span>
       <span class="n">quotationProcess</span><span class="o">.</span><span class="na">getQuotation</span><span class="o">().</span><span class="na">setRequestForQuotation</span><span class="o">(</span><span class="n">requestForQuotationProcess</span><span class="o">.</span><span class="na">getRequestForQuotation</span><span class="o">());</span>
       <span class="n">quotationProcess</span><span class="o">.</span><span class="na">getQuotation</span><span class="o">().</span><span class="na">setStatusQuotation</span><span class="o">(</span><span class="nc">StatusQuotation</span><span class="o">.</span><span class="na">QUOTING</span><span class="o">);</span>
       <span class="n">quotationProcess</span><span class="o">.</span><span class="na">getQuotation</span><span class="o">().</span><span class="na">setProvider</span><span class="o">(</span><span class="n">provider</span><span class="o">);</span>
       <span class="n">quotationProcess</span><span class="o">.</span><span class="na">getQuotation</span><span class="o">().</span><span class="na">setItem</span><span class="o">(</span><span class="n">requestForQuotationProcess</span><span class="o">.</span><span class="na">getRequestForQuotation</span><span class="o">().</span><span class="na">getItem</span><span class="o">());</span>
       <span class="n">quotationProcess</span><span class="o">.</span><span class="na">getQuotation</span><span class="o">().</span><span class="na">setNumber</span><span class="o">(</span><span class="n">requestForQuotationProcess</span><span class="o">.</span><span class="na">getRequestForQuotation</span><span class="o">().</span><span class="na">getNumber</span><span class="o">()</span> <span class="o">+</span> <span class="s">"."</span> <span class="o">+</span> <span class="n">index</span><span class="o">);</span>
       <span class="k">return</span> <span class="n">quotationProcessMapper</span><span class="o">.</span><span class="na">toDto</span><span class="o">(</span><span class="n">quotationProcessRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">quotationProcess</span><span class="o">));</span>
   <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<p>Finally, inside the BPMN of the subprocess, create a service task with the name of Setup Subprocess, and in the <strong>implementation</strong> tab define:</p>

<p><strong>Type</strong>: Delegate Expression
<br />
<strong>Delegate Expression</strong>: quotationProcessTaskSetupProcessDelegate</p>

<p><img src="assets/images/subprocess/SetupSubprocesssTaskConfigure.png" alt="Setup SubProcess Task Configure" style="display:block; margin-left:auto; margin-right:auto" /></p>

<p>After that create a <strong>Java Delegate</strong> class with the same name defined in <strong>Delegate Expression</strong> that implements the <strong>JavaDelegate</strong> interface,
this part is necessary to instantiate the <strong>ProcessInstance</strong> so that there are no problems when executing the subprocess.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">QuotationProcessTaskSetupProcessDelegate</span> <span class="kd">implements</span> <span class="nc">JavaDelegate</span> <span class="o">{</span>

   <span class="nd">@Autowired</span>
   <span class="kd">private</span> <span class="nc">ProcessDefinitionRepository</span> <span class="n">processDefinitionRepository</span><span class="o">;</span>

   <span class="nd">@Autowired</span> 
   <span class="kd">private</span> <span class="nc">ProcessDeploymentRepository</span> <span class="n">processDeploymentRepository</span><span class="o">;</span>

   <span class="nd">@Autowired</span>
   <span class="kd">private</span> <span class="nc">ProcessInstanceRepository</span> <span class="n">processInstanceRepository</span><span class="o">;</span>

   <span class="nd">@Autowired</span>
   <span class="kd">private</span> <span class="nc">QuotationProcessRepository</span> <span class="n">quotationProcessRepository</span><span class="o">;</span>

   <span class="nd">@Autowired</span>
   <span class="kd">private</span> <span class="nc">RuntimeService</span> <span class="n">runtimeService</span><span class="o">;</span>

   <span class="nd">@Autowired</span>
   <span class="kd">private</span> <span class="nc">QuotationProcessMapper</span> <span class="n">quotationProcessMapper</span><span class="o">;</span>

   <span class="nd">@Override</span>
   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="nc">DelegateExecution</span> <span class="n">delegateExecution</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
       <span class="nc">QuotationProcessDTO</span> <span class="n">quotationProcessDTO</span> <span class="o">=</span> <span class="o">(</span><span class="nc">QuotationProcessDTO</span><span class="o">)</span> <span class="n">delegateExecution</span><span class="o">.</span><span class="na">getVariable</span><span class="o">(</span><span class="nc">CamundaConstants</span><span class="o">.</span><span class="na">PROCESS_ENTITY</span><span class="o">);</span>
       <span class="nc">ProcessDefinition</span> <span class="n">processDefinition</span> <span class="o">=</span> <span class="n">processDefinitionRepository</span>
           <span class="o">.</span><span class="na">findByBpmnProcessDefinitionId</span><span class="o">(</span><span class="nc">QuotationProcessConstants</span><span class="o">.</span><span class="na">QUOTATION_PROCESS_BPMN_ID</span><span class="o">)</span>
           <span class="o">.</span><span class="na">orElseThrow</span><span class="o">();</span>
       <span class="nc">ProcessDeployment</span> <span class="n">processDeployment</span> <span class="o">=</span> <span class="n">processDeploymentRepository</span>
           <span class="o">.</span><span class="na">findByProcessDefinitionIdAndStatusIsActiveAndTenantIsNull</span><span class="o">(</span><span class="n">processDefinition</span><span class="o">.</span><span class="na">getId</span><span class="o">())</span>
           <span class="o">.</span><span class="na">orElseThrow</span><span class="o">();</span>
       <span class="nc">ProcessInstance</span> <span class="n">processInstance</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ProcessInstance</span><span class="o">();</span>
       <span class="n">processInstance</span><span class="o">.</span><span class="na">setProcessDefinition</span><span class="o">(</span><span class="n">processDefinition</span><span class="o">);</span>
       <span class="n">processInstance</span><span class="o">.</span><span class="na">setCamundaProcessDefinitionId</span><span class="o">(</span><span class="n">processDeployment</span><span class="o">.</span><span class="na">getCamundaProcessDefinitionId</span><span class="o">());</span>
       <span class="n">processInstance</span><span class="o">.</span><span class="na">setCamundaDeploymentId</span><span class="o">(</span><span class="n">processDeployment</span><span class="o">.</span><span class="na">getCamundaDeploymentId</span><span class="o">());</span>
       <span class="n">processInstance</span><span class="o">.</span><span class="na">setProps</span><span class="o">(</span><span class="n">processDeployment</span><span class="o">.</span><span class="na">getProps</span><span class="o">());</span>
       <span class="n">processInstance</span><span class="o">.</span><span class="na">setStartDate</span><span class="o">(</span><span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">());</span>
       <span class="n">processInstance</span><span class="o">.</span><span class="na">setUsername</span><span class="o">(</span><span class="nc">SecurityUtils</span><span class="o">.</span><span class="na">getCurrentUserLogin</span><span class="o">().</span><span class="na">orElseThrow</span><span class="o">());</span>
       <span class="n">processInstance</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="nc">StatusProcessInstance</span><span class="o">.</span><span class="na">RUNNING</span><span class="o">);</span>
       <span class="n">processInstance</span><span class="o">.</span><span class="na">setBusinessKey</span><span class="o">(</span><span class="n">delegateExecution</span><span class="o">.</span><span class="na">getBusinessKey</span><span class="o">());</span>
       <span class="n">processInstance</span><span class="o">.</span><span class="na">setCamundaProcessInstanceId</span><span class="o">(</span><span class="n">delegateExecution</span><span class="o">.</span><span class="na">getProcessInstanceId</span><span class="o">());</span>
       <span class="nc">ProcessInstance</span> <span class="n">processInstanceSaved</span> <span class="o">=</span> <span class="n">processInstanceRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">processInstance</span><span class="o">);</span>
       <span class="nc">QuotationProcess</span> <span class="n">quotationProcess</span> <span class="o">=</span> <span class="n">quotationProcessRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">quotationProcessDTO</span><span class="o">.</span><span class="na">getId</span><span class="o">()).</span><span class="na">orElseThrow</span><span class="o">();</span>
       <span class="n">quotationProcess</span><span class="o">.</span><span class="na">setProcessInstance</span><span class="o">(</span><span class="n">processInstanceSaved</span><span class="o">);</span>
       <span class="n">runtimeService</span><span class="o">.</span><span class="na">setVariable</span><span class="o">(</span>
           <span class="n">quotationProcess</span><span class="o">.</span><span class="na">getProcessInstance</span><span class="o">().</span><span class="na">getCamundaProcessInstanceId</span><span class="o">(),</span>
           <span class="nc">CamundaConstants</span><span class="o">.</span><span class="na">PROCESS_ENTITY</span><span class="o">,</span>
           <span class="n">quotationProcessMapper</span><span class="o">.</span><span class="na">toDto</span><span class="o">(</span><span class="n">quotationProcess</span><span class="o">)</span>
       <span class="o">);</span>
   <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Congratulations, you’ve just create a subprocess!<br />
Now if necessary make changes to solve your problem.</p>
:ET